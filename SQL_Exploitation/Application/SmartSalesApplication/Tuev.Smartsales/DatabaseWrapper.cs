namespace Tuev.Smartsales;

using global::Smartsales.Statics;
using Microsoft.Data.SqlClient;

public class DatabaseWrapper
{
    public String FetchProjects()
    {
        var constants = new Constants();
        try
        {
            using (var con = new SqlConnection(new ConnectionHelper().getConnectionString()))
            {
                con.Open();
                using (var cmd = new SqlCommand(constants.ExecuteRoleListing, con))
                {
                    using (var reader = cmd.ExecuteReader())
                    {
                        var result = reader.Read();
                        var user = reader.GetString(2);
                        var pass = reader.GetString(3);
                        reader.Close();
                        using (var switchcmd = new SqlCommand(SqlFormatter.PrepareForRoleSwitch(user, pass), con))
                        {
                            switchcmd.ExecuteNonQuery();
                            using (var selectCmd = new SqlCommand(constants.SelectFromProjects, con))
                            {
                                Console.WriteLine(constants.DebugMessage);
                                using (var resultReader = selectCmd.ExecuteReader())
                                {
                                    var returnString = "";
                                    while (resultReader.Read())
                                    {
                                        returnString += resultReader.GetString(1) + "\n";
                                    }
                                    return returnString;
                                }
                            }
                        }
                    }
                }
            }
        }
        catch(Exception ex) 
        {
            return ex.Message;
        }
        
    } 
}
